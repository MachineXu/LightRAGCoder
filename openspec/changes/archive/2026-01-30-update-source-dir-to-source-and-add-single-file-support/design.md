## Context

LightRAGCoder 是一个代码分析工具，当前使用 `--source-dir` 参数来指定要分析的源代码目录。参数名称暗示只支持目录，但用户需求已经扩展到希望支持单个源代码文件的分析。当前实现中，`--source-dir` 参数通过 `add_source_dir_arg()` 函数添加到 build 命令中，并接受逗号分隔的目录路径列表。

## Goals / Non-Goals

**Goals:**
1. 将 `--source-dir` 参数重命名为 `--source`，提供更通用的语义
2. 扩展 `--source` 参数的功能，支持指定单个文件和目录
3. 更新所有相关文档和帮助文本
4. 保持合理的向后兼容性，或提供清晰的迁移路径

**Non-Goals:**
1. 不改变现有的目录递归分析逻辑（如果目录被指定，仍然分析其中的所有文件）
2. 不添加复杂的文件类型过滤功能（保持现有行为）
3. 不修改其他命令的参数结构（仅影响 build 命令）
4. 不改变底层存储或分析引擎的架构

## Decisions

### Decision 1: 参数重命名策略
**选择**: 直接重命名为 `--source`，不保留 `--source-dir` 作为别名
**理由**: 
- 简化代码库，避免维护两个参数名称的复杂性
- 清晰的断点有助于用户快速迁移到新参数
- 可以在发布说明和错误信息中提供明确的迁移指导
**替代方案考虑**: 
- 保留 `--source-dir` 作为临时别名（被拒绝，因为会增加代码复杂度）
- 同时支持两个参数名（被拒绝，可能导致混淆和代码冗余）

### Decision 2: 参数值解析逻辑
**选择**: 修改参数解析逻辑以同时支持文件和目录
**实现方案**:
1. 保持现有的逗号分隔值解析
2. 对每个路径值进行 `os.path.exists()` 检查
3. 如果是文件，直接添加到分析列表
4. 如果是目录，递归收集目录中的所有文件（保持现有行为）
5. 如果路径不存在，提供清晰的错误信息
**理由**: 最小化变更，重用现有目录处理逻辑

### Decision 3: 函数重命名
**选择**: 将 `add_source_dir_arg()` 函数重命名为 `add_source_arg()`
**理由**: 函数名称应该反映其实际功能，即添加源参数（支持文件和目录）

### Decision 4: 帮助文本更新
**选择**: 更新帮助文本为 "Comma-separated list of source files or directories"
**理由**: 准确描述参数功能，帮助用户理解新能力

### Decision 5: 文档更新策略
**选择**: 在同一个变更中更新所有文档
**理由**: 确保代码和文档的一致性，避免用户混淆
**具体文档**:
- README.md（英文文档）
- LightRAGCoder使用说明.md（中文文档）
- 命令行帮助文本

### Decision 6: 移除路径格式转换和标准化
**选择**: 删除所有将反斜杠替换为正斜杠的操作（`replace('\\', '/')`），并移除 `as_posix()` 调用
**理由**:
- 现代Python的`pathlib.Path`和文件系统操作能正确处理不同操作系统的路径分隔符
- 保持原始路径格式，避免不必要的转换
- 简化代码逻辑，减少潜在错误
- 实际文件操作（如`open()`、`os.path`函数）能正确处理原生路径格式
**影响位置**:
1. `storage_setting.py` 第131行: `get_source_dirs_from_settings()` 函数中的路径标准化
2. `storage_setting.py` 第157行: `create_default_settings()` 函数中的路径标准化
3. `lightragcoder.py` 第149行: 命令行参数解析中的路径标准化
**修改方案**: 直接使用原始路径字符串，移除 `replace('\\', '/')` 和 `as_posix()` 调用。仅在需要显示统一格式时（如日志、UI）进行路径格式化。

### Decision 7: 更新相关函数以支持文件路径
**选择**: 修改相关函数逻辑以同时支持文件和目录路径，但不强制重命名函数
**具体修改**:
1. `get_source_dirs_from_settings()` 函数: 保持原名但更新内部逻辑，支持文件路径
2. `create_default_settings()` 函数: 更新参数名和逻辑以支持文件和目录
3. 相关变量名: 将 `source_dirs` 等变量名改为 `source_paths` 或保持原名但注释说明支持文件
**理由**: 最小化变更范围，避免大规模重命名带来的风险。通过函数逻辑更新实现功能扩展，而不是通过重命名。

### Decision 8: 更新文件读取逻辑以支持单个文件
**选择**: 修改 `repo_graphrag/utils/file_reader.py` 中的 `read_dir()` 函数以支持单个文件输入
**具体修改**:
1. 在 `read_dir()` 函数中添加路径类型检查：使用 `os.path.isfile()` 和 `os.path.isdir()`
2. 如果是文件，直接处理该文件（不进行 `os.walk` 递归）
3. 如果是目录，保持现有的 `os.walk` 递归逻辑
4. 更新函数文档字符串，说明现在支持文件和目录
5. 考虑是否重命名函数为 `read_paths()` 或保持原名但更新注释
**理由**:
- `file_reader.py` 是实际读取文件内容的核心模块，必须支持单个文件
- 保持向后兼容性，现有调用代码无需修改
- 统一处理文件和目录的逻辑，简化调用方代码
**影响位置**:
- `repo_graphrag/utils/file_reader.py` 中的 `read_dir()` 函数实现
- 调用 `read_dir()` 的代码（如 `graph_storage_creator.py`）会自动受益

## Risks / Trade-offs

**[Risk] 用户脚本中断风险**：现有使用 `--source-dir` 的脚本将立即失效
- **Mitigation**: 在发布说明和错误信息中提供明确的迁移指导。可以考虑在下一个次要版本中提供过渡期警告。

**[Risk] 路径验证复杂性**：需要区分文件和目录，可能增加错误处理的复杂性
- **Mitigation**: 使用 `os.path.isfile()` 和 `os.path.isdir()` 进行明确检查，提供清晰的错误信息。

**[Risk] 性能影响**：对大量小文件的检查可能比目录检查更慢
- **Mitigation**: 保持现有目录递归逻辑不变，文件检查是轻量级操作，影响可忽略。

**[Risk] 文档不完整**：可能遗漏某些文档位置的更新
- **Mitigation**: 使用全局搜索 (`grep`) 查找所有 `--source-dir` 的出现位置，确保全面更新。

**[Risk] 路径格式不一致**：移除斜杠替换可能导致Windows路径格式不一致
- **Mitigation**: 确保 `pathlib.Path` 能正确处理路径操作，测试跨平台兼容性。

**[Risk] 函数名与功能不匹配**：`get_source_dirs_from_settings()` 函数名暗示只处理目录，但现在支持文件
- **Mitigation**: 添加注释说明，或考虑重命名为 `get_source_paths_from_settings()`（但保持原名以最小化变更）

**[Trade-off] 向后兼容性 vs 代码简洁性**
- **选择**: 优先代码简洁性，要求用户更新参数名称
- **理由**: 这是语义上的改进，不是功能破坏，用户可以轻松迁移

**[Trade-off] 路径标准化 vs 原始格式**
- **选择**: 移除斜杠替换，保持原始路径格式
- **理由**: 简化代码，依赖 `pathlib` 的跨平台处理能力

**[Risk] 文件读取逻辑复杂性增加**：`read_dir()` 函数需要处理两种不同类型的输入（文件和目录）
- **Mitigation**: 使用清晰的逻辑分支，保持代码可读性，添加充分的单元测试覆盖文件和目录场景

**[Risk] 函数名误导性**：`read_dir()` 函数名暗示只处理目录，但现在支持文件
- **Mitigation**: 更新文档字符串明确说明，或考虑重命名为 `read_paths()`（但保持原名以最小化变更影响）

## Migration Plan

1. **开发阶段**:
   - 修改代码和文档，更新所有 `--source-dir` 引用为 `--source`
   - 删除所有 `replace('\\', '/')` 斜杠替换操作
   - 更新相关函数逻辑以支持文件路径
   - 修改 `repo_graphrag/utils/file_reader.py` 中的 `read_dir()` 函数以支持单个文件输入
2. **测试阶段**:
   - 验证文件和目录输入都能正常工作
   - 测试跨平台路径兼容性（Windows/Unix）
   - 验证路径格式转换移除后的功能正常
   - 测试 `file_reader.py` 正确处理单个文件和目录混合输入
3. **发布准备**:
   - 更新 CHANGELOG.md，明确说明破坏性变更和迁移步骤
   - 确保所有文档示例使用新参数
4. **用户沟通**:
   - 在错误信息中提供帮助文本，指导用户使用新参数
   - 说明路径格式不再自动转换，保持原始格式
5. **后续支持**:
   - 考虑在下一个版本中临时添加弃用警告（如果用户反馈需要过渡期）
   - 监控路径相关问题的用户反馈

## Open Questions

1. 是否需要在参数值中支持通配符模式（如 `*.py`）？
   - **当前决策**: 暂不支持，保持简单性
   - **理由**: 可以通过 shell 扩展或逗号分隔的完整文件列表实现相同功能

2. 如何处理符号链接？
   - **当前决策**: 保持现有行为（跟随符号链接）
   - **理由**: 不改变现有目录处理逻辑

3. 是否添加文件大小或数量限制？
   - **当前决策**: 不添加新限制
   - **理由**: 保持与现有目录处理行为一致

4. 是否完全移除 `as_posix()` 调用，还是仅移除 `replace('\\', '/')`？
   - **更新决策**: 可以完全移除 `as_posix()` 调用，直接使用原始路径字符串
   - **理由**:
     - 实际文件系统操作（如 `open()`、`os.path` 函数）能正确处理不同操作系统的路径格式
     - 简化代码，减少不必要的路径转换
     - 保持路径的原始表示，避免转换可能引入的问题
     - 仅在需要显示或存储统一格式时进行转换（如日志、设置文件）

5. 是否需要更新 `storage_setting.py` 中的 `source_dir` 字段名？
   - **当前决策**: 保持字段名不变，但注释说明支持文件和目录
   - **理由**: 避免存储格式的破坏性变更，保持设置文件的向后兼容性

6. 是否需要重命名 `read_dir()` 函数以反映其支持文件的功能？
   - **当前决策**: 保持函数名不变，但更新文档字符串明确说明支持文件和目录
   - **理由**: 最小化变更影响，避免修改所有调用点。函数名的误导性可以通过文档弥补。